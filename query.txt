# associare ad ogni cliente il relativo tasso di cambio
CREATE VIEW Cliente_Tax (codCli, codPag, valuta, tassoCambio, bud_cons) AS
SELECT Nr_origine, Cod_condizioni_pagamento, clienti.Codice_valuta, Tasso_cambio_medio, Budget_consuntivo
FROM clienti, tassi_di_cambio
WHERE clienti.Codice_valuta = tassi_di_cambio.Codice_valuta

# associare ogni cliente alla sua vendita
CREATE VIEW Cliente_Adj (codCli, codPag, valuta, tassoCambio, budget_cons, Nr_articolo, Quantità, importo_tot) AS
SELECT codCli, codPag, valuta, tassoCambio, budget_consuntivo, Nr_articolo, Quantita, Importo_vendita
FROM vendita, Cliente_Tax
WHERE Nr_origine = codCli AND  Budget_consuntivo = bud_cons

# estrazione/separazione in tabella VenditeBudget.csv e VenditeConsuntivo.csv
CREATE VIEW Vendite_Budget(codCli, codPag, valuta, tassoCambio, codArt, Quantità, importo_tot) AS
SELECT codCli, codPag, valuta, tassoCambio, Nr_articolo, Quantità, importo_tot
FROM Cliente_Adj
WHERE budget_cons = 0

CREATE VIEW Vendite_Consuntivo(codCli, codPag, valuta, tassoCambio, codArt, Quantità, importo_tot) AS
SELECT codCli, codPag, valuta, tassoCambio, Nr_articolo, Quantità, importo_tot
FROM Cliente_Adj
WHERE budget_cons = 1

# unire/sommare per articolo (sia in VenditeBudget.csv che in VenditeConsuntivo.csv)
CREATE VIEW Vendite_Budget_X_art(codArt, P, qta, P_unit) AS
SELECT codArt, sum(importo_tot)*tassoCambio AS P, sum(Quantità) AS qta, sum(importo_tot)*tassoCambio/Quantità AS P_unit
FROM Vendite_Budget
WHERE Quantità != 0
GROUP BY codArt

CREATE VIEW Vendite_Consuntivo_X_art(codArt, P, qta, P_unit) AS
SELECT codArt, sum(importo_tot)*tassoCambio AS P, sum(Quantità) AS qta, sum(importo_tot)*tassoCambio/Quantità AS P_unit
FROM Vendite_Consuntivo
WHERE Quantità != 0
GROUP BY codArt

# creare una tabella ImpiegoCostoRisorseBudget.csv (Impiego orario risorse.csv join(Risorsa) Costo orario risorse - budget.csv) e ImpiegoCostoRisorseConsuntivo.csv (Impiego orario risorse.csv join(Risorsa) Costo orario risorse - consuntivo.csv)
CREATE VIEW Impiego_Costo_Risorse_Budget(codArt, codOrd, area, codArea, risorsa, t, q, costoH) AS
SELECT Nr_articolo, Nr_ordine_produzione, Descrizione, I.Nr_Area_produzione, I.Risorsa, Tempo_risorsa, Quantita_output, Costo_orario
FROM impiego_orario_risorse AS I, costo_orario_risorse_budget AS C
WHERE I.Risorsa = C.Risorsa AND I.Nr_area_produzione = C.Area_produzione AND budget_consuntivo = 0

CREATE VIEW Impiego_Costo_Risorse_Consuntivo(codArt, codOrd, area, codArea, risorsa, t, q, costoH) AS
SELECT Nr_articolo, Nr_ordine_produzione, Descrizione, I.Nr_Area_produzione, I.Risorsa, Tempo_risorsa, Quantita_output, Costo_orario
FROM impiego_orario_risorse AS I, costo_orario_risorse_budget AS C
WHERE I.Risorsa = C.Risorsa AND I.Nr_area_produzione = C.Area_produzione AND budget_consuntivo = 1

# calcolare ((costoHris * tempo risorsa)/Quantità di output) per ogni articolo e per ogni area produttiva delle due tabelle
CREATE VIEW Costo_produzione_Budget_X_art(codArt, C_unit, qta) AS
SELECT Codice_articolo, sum(C_unit), sum(qta)
FROM   (SELECT Codice_articolo, sum(Costo_totale/qta) AS C_unit, qta, a.Codice_ordine
		FROM(	SELECT Codice_articolo, Area , sum(Tempo)*Costo_orario AS Costo_totale, sum(Quantita) AS qta, Codice_ordine
				FROM Impiego_Costo_Risorse_Budget
				GROUP BY Codice_articolo, Codice_ordine, area) AS a
		GROUP BY a.Codice_articolo, a.Codice_ordine
		HAVING qta != 0) AS a1
GROUP BY a1.Codice_articolo

CREATE VIEW Costo_produzione_Consuntivo_X_art(codArt, C_unit, qta) AS
SELECT Codice_articolo, sum(C_unit), sum(qta)
FROM   (SELECT Codice_articolo, sum(Costo_totale/qta) AS C_unit, qta, a.Codice_ordine
		FROM(	SELECT Codice_articolo, Area , sum(Tempo)*Costo_orario AS Costo_totale, sum(Quantita) AS qta, Codice_ordine
				FROM Impiego_Costo_Risorse_Consuntivo
				GROUP BY Codice_articolo, Codice_ordine, area) AS a
		GROUP BY a.Codice_articolo, a.Codice_ordine
		HAVING qta != 0) AS a1
GROUP BY a1.Codice_articolo

# calcolo tabella impiegoCostoOrarioRisorseBudget
CREATE VIEW Costi_impiego_area_budget(area, codArea, costo, tempo, qta) AS
SELECT area, codArea, sum(costoH), sum(t), sum(q)
FROM Impiego_Costo_Risorse_Budget
GROUP BY area

# calcolo tabella impiegoCostoOrarioRisorseConsuntivo
CREATE VIEW Costi_impiego_area_consuntivo(area, codArea, costo, tempo, qta) AS
SELECT area, codArea, sum(costoH), sum(t), sum(q)
FROM Impiego_Costo_Risorse_Consuntivo
GROUP BY area

# creare una tabella (template) ScostamentiCosto.csv e ScostamentiMcd.csv in cui sulle righe ho gli articoli e sulle colonne le aree produttive

CREATE VIEW Impiego_tmp(codArt, budg_cons, OdP, t, q) AS
SELECT Nr_articolo , Budget_consuntivo, Nr_ordine_produzione, sum(Tempo_risorsa), sum(Quantita_output)  
FROM impiego_orario_risorse AS i
GROUP BY i.Nr_articolo, i.Nr_ordine_produzione

CREATE VIEW Consumi_tmp(codArt, budg_cons, OdP, q_MP, importo) AS
SELECT Nr_Articolo, Budget_consuntivo, Nr_documento, sum(Quantita_MP_impiegata) as Quantita_MP_impiegata, sum(Importo_costo) as Importo_costo
FROM consumi
GROUP BY Nr_Articolo, Nr_documento


# collegamento OdP consumi-impieghi
CREATE VIEW Costo_MP_budget_x_art(codArt, OdP, t, qta, qta_MP, costo_tot, costo_unita)AS
SELECT i.codArt, i.OdP, t, q, q_MP, importo, importo/q as costo_unita
FROM consumi_tmp AS c, impiego_tmp AS i
WHERE c.OdP = i.OdP AND c.codArt = i.codArt AND c.budg_cons = i.budg_cons AND c.budg_cons = 0

CREATE VIEW Costo_MP_consuntivo_x_art(codArt, OdP, t, qta, qta_MP, costo_tot, costo_unita)AS
SELECT i.codArt, i.OdP, t, q, q_MP, importo, importo/q as costo_unita
FROM consumi_tmp AS c, impiego_tmp AS i
WHERE c.OdP = i.OdP AND c.codArt = i.codArt AND c.budg_cons = i.budg_cons AND c.budg_cons = 1

# calcolo mix produttivo per articolo
CREATE VIEW Mix_X_art_budget(codArt, val) AS
SELECT Codice_articolo, Quantita/(SELECT sum(Quantita)
							FROM Vendite_Budget) 
FROM Vendite_Budget

CREATE VIEW Mix_X_art_consuntivo(codArt, val) AS
SELECT Codice_articolo, Quantita/(SELECT sum(Quantita)
					FROM Vendite_Consuntivo) 
FROM Vendite_Consuntivo

# calcolo quantità mixStandard
CREATE VIEW Mix_standard(codArt, qta) AS
SELECT codArt, m.val * (SELECT sum(Quantita)
								FROM Vendite_Consuntivo) 
FROM Mix_X_art_budget AS m

# calcolo quantità mixEffettivo
CREATE VIEW Mix_effettivo(codArt, qta) AS
SELECT codArt, m.val * (SELECT sum(Quantita)
								FROM Vendite_Consuntivo) 
FROM Mix_X_art_consuntivo AS m
